{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    body {
        margin: 0;
        padding: 0;
        background-color: #f8f9fa; /* èƒŒæ™¯è‰² */
    }
    
    .container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 60px); /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã®é«˜ã•åˆ†ã‚’å¼•ã */
        margin-top: 60px; /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã®é«˜ã•ã‚’ç¢ºä¿ */
        text-align: center;
    }
    
    .post-container {
        position: relative;
        max-width: 450px;
        width: 100%;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .post-info {
        display: flex;
        align-items: center;
    }

    .profile-image img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }

    .post-user-info {
        margin-left: 10px;
        font-size: 16px;
    }

    .post-user-info a {
        text-decoration: none;
        color: #333;
        font-weight: bold;
    }

    .like-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .like-button {
        border: none;
        background: none;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
    }
    
    .like-count {
        font-size: 16px;
        margin: 0;
    }    
</style>

<div class="container d-flex justify-content-center align-items-center" 
     style="height: 100vh; flex-direction: column; text-align: center;">

    <!-- æŠ•ç¨¿ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ1ã¤ã«çµ±ä¸€ï¼‰ -->
    <div class="post-container" style="position: relative; max-width: 450px; width: 100%; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">

        <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ (æŠ•ç¨¿è€…ã®ã¿è¡¨ç¤º) -->
        {% if user == post.user %}
        <form action="{% url 'post_delete' post.pk %}" method="post" style="position: absolute; top: 10px; right: 10px;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm">æŠ•ç¨¿å‰Šé™¤</button>
        </form>
        {% endif %}

        <!-- æŠ•ç¨¿æƒ…å ± -->
        <div class="post-info d-flex align-items-center mb-3">
            <div class="profile-image">
                {% if user_profile.profile_image %}
                    <img src="{{ user_profile.profile_image.url }}" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ">
                {% else %}
                    <img src="{% static 'default-profile.png' %}" alt="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒ">
                {% endif %}
            </div>
            <div class="post-user-info">
                <a href="{% url 'profile' account_name=user_profile.account_name %}">
                    <strong>@{{ user_profile.account_name }}</strong>
                </a>
            </div>
        </div>

        <!-- æŠ•ç¨¿ç”»åƒ -->
        <div class="image-wrapper mb-3">
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="img-fluid"
                 style="width: 100%; max-width: 400px; border-radius: 10px;">
        </div>

        <!-- ã„ã„ã­ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ -->
        <div class="action-buttons d-flex align-items-center justify-content-center mb-3" style="gap: 20px;">
            <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ã¨ã‚«ã‚¦ãƒ³ãƒˆ -->
             <div class="like-container d-flex align-items-center"> 
                {% comment %} <button class="like-button" data-url="{% url 'like_post' post.id %}" 
                        style="color: {% if user in post.likes.all %}black{% else %}gray{% endif %};">
                    {% if user in post.likes.all %}
                    â™¥
                    {% else %}
                    â™¡
                    {% endif %}
                </button>
                <p class="like-count mb-0">{{ post.likes.count }}</p> {% endcomment %}
                <button class="like-button" data-post-id="{{ post.id }}" style="border: none; background: none; font-size: 24px;">
                    <span class="like-icon" style="color: {% if user_has_liked %}black{% else %}gray{% endif %};">
                        {% if user_has_liked %}â™¥{% else %}â™¡{% endif %}
                    </span>
                </button>
                <span class="like-count">{{ post.likes.count }}</span>
                
            </div> 
        </div>

        <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ -->
        {% if user.is_authenticated %}
        <div id="comment-section" class="mt-3">
            <form id="comment-form" data-post-id="{{ post.id }}" class="d-flex justify-content-center">
                {% csrf_token %}
                <input type="text" name="content" id="comment-content" class="form-control" 
                       placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." style="flex: 1; max-width: 300px; margin-right: 5px;">
                <button type="submit" class="btn btn-primary">é€ä¿¡</button>
            </form>
        </div>
        {% else %}
        <p class="mt-3">ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        {% endif %}

        <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
        <div class="comments mt-3">
            <ul id="comment-list" class="list-unstyled">
                {% for comment in post.comments.all %}
                <li id="comment-{{ comment.id }}" class="d-flex align-items-center justify-content-between" style="margin-bottom: 10px;">
                    <span>
                        <strong>@{{ comment.user.account_name }}</strong>: {{ comment.content }}
                    </span>
                    {% if user.id == comment.user.id %}
                    <button class="delete-comment btn btn-sm btn-outline-danger" data-comment-id="{{ comment.id }}">ğŸ—‘ï¸</button>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>

    </div> 
</div> 

<!-- JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".like-button").forEach(button => {
            button.addEventListener("click", function(event) {
                event.preventDefault();  // âœ… ãƒšãƒ¼ã‚¸é·ç§»ã‚’é˜²ã
                console.log("ã„ã„ã­ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
    
                const postId = this.getAttribute("data-post-id");
                const url = `/like/${postId}/`;  // âœ… æ­£ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
                const likeIcon = this.querySelector(".like-icon");
                const likeCount = this.nextElementSibling;
    
                console.log(`POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡: ${url}`);
    
                fetch(url, {  
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    console.log("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡");
                    return response.json();
                })
                .then(data => {
                    console.log("ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", data);
                    if (data.liked) {
                        likeIcon.innerHTML = "â™¥";  
                        likeIcon.style.color = "black";
                    } else {
                        likeIcon.innerHTML = "â™¡";  
                        likeIcon.style.color = "gray";
                    }
                    likeCount.textContent = data.like_count;
                })
                .catch(error => console.error("ã‚¨ãƒ©ãƒ¼:", error));
            });
        });
    });
    
        // âœ… ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«æœ€æ–°ã®ã„ã„ã­çŠ¶æ…‹ã‚’å–å¾—ã—ã¦æ›´æ–°
        document.querySelectorAll(".like-button").forEach(button => {
            const postId = button.getAttribute("data-post-id");
            const likeIcon = button.querySelector(".like-icon");
    
            fetch(`/like/${postId}/status/`, {  
                method: "GET",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("ã„ã„ã­çŠ¶æ…‹å–å¾—:", data);  // âœ… ã„ã„ã­çŠ¶æ…‹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
                if (data.liked) {
                    likeIcon.innerHTML = "â™¥";  
                    likeIcon.style.color = "black";
                } else {
                    likeIcon.innerHTML = "â™¡";  
                    likeIcon.style.color = "gray";
                }
            })
            .catch(error => console.error("ã‚¨ãƒ©ãƒ¼:", error));
        });
    });
    
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    document.addEventListener("DOMContentLoaded", function () {
        const commentForm = document.getElementById("comment-form");
        const commentInput = document.getElementById("comment-content");
        const commentList = document.getElementById("comment-list");
    
        if (commentForm) {
            commentForm.addEventListener("submit", function (event) {
                event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é˜²ã
    
                const postId = commentForm.getAttribute("data-post-id");
                const content = commentInput.value.trim();
    
                if (content === "") {
                    alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return;
                }
    
                fetch(`/comment/${postId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ content: content }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
    
                    // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    const newComment = document.createElement("li");
                    newComment.id = `comment-${data.comment_id}`;
                    newComment.classList.add("d-flex", "align-items-center", "justify-content-between");
                    newComment.style.marginBottom = "10px";
                    newComment.innerHTML = `
                        <span>
                            <strong>@${data.user_account}</strong>: ${data.content}
                        </span>
                        <button class="delete-comment btn btn-sm btn-outline-danger" data-comment-id="${data.comment_id}">ğŸ—‘ï¸</button>
                    `;
    
                    commentList.appendChild(newComment);
                    commentInput.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    
                    attachDeleteEvent(); // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚‚å‰Šé™¤æ©Ÿèƒ½ã‚’é©ç”¨
                })
                .catch(error => console.error("ã‚¨ãƒ©ãƒ¼:", error));
            });
        }
    
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é©ç”¨
        function attachDeleteEvent() {
            document.querySelectorAll(".delete-comment").forEach(button => {
                button.addEventListener("click", function () {
                    const commentId = this.getAttribute("data-comment-id");
    
                    fetch(`/delete-comment/${commentId}/`, {
                        method: "DELETE",
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken"),
                            "Content-Type": "application/json",
                        },
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼");
                        }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById(`comment-${commentId}`).remove();
                    })
                    .catch(error => console.error("ã‚¨ãƒ©ãƒ¼:", error));
                });
            });
        }
    
        attachDeleteEvent(); // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚‚é©ç”¨
    });    
</script>

{% endblock %}
