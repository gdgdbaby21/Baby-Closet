{% extends 'base.html' %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"> 
    <title>ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆæŠ•ç¨¿</title>
    <style>
        .title-container {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center; 
            margin-top: 10px;
            margin-left: 10px;
            margin-bottom: 20px;
        }
        
        .title-container h1 {
            margin: 0;
            font-size: 18px;
            font-weight: normal;
            margin-top: 30px;
        }
        
        body {
            font-size: 18px !important; 
            margin: 0;
            padding: 0;
            background-color: #f8f8f8;
            font-family: Arial, sans-serif;
        }
        
        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin: 0 auto; 
        }
        .form-label {
            font-size: 18px !important;
            font-weight: bold !important;
        }
        .form-group {
            max-width: 400px !important; 
            width: 100% !important; 
            margin-bottom: 15px;
        }
        .form-group,
        .mb-3 {
            width: 50% !important;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100% !important; 
            height: 120px !important;  
            font-size: 18px !important; 
            padding: 15px !important; 
            border: 1px solid #ddd !important;
            border-radius: 6px !important;
            background-color: white !important;
            box-sizing: border-box !important; 
        }

        .btn-gray {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: white !important;
        }
        
        #selected-items-list {
            display: flex;
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .item-container span {
            flex-grow: 1;
            margin-right: 20px; 
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-size: 12px; 
        }
        #title::placeholder {
            font-size: 12px !important; 
            color: #999 !important; 
        }
        
        /* ãƒ¡ãƒ¢ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ–‡å­—ã‚’å°ã•ã */
        #caption::placeholder {
            font-size: 12px !important;
            color: #999 !important;
        }
        #title {
            width: 100% !important; /* å¹…ã‚’æœ€å¤§é™åºƒã’ã‚‹ */
            height: 40px !important; /* é«˜ã•ã‚’å°‘ã—å¤§ãã */
            font-size: 18px !important;
            padding: 12px !important;
            box-sizing: border-box !important;
        }
        
        #caption {
            width:100% !important; /* å¹…ã‚’æœ€å¤§é™åºƒã’ã‚‹ */
            height: 200px !important; /* é«˜ã•ã‚’ã•ã‚‰ã«æ‹¡å¤§ */
            font-size: 18px !important;
            padding: 12px !important;
            box-sizing: border-box !important;
        }
    /* ã‚¢ã‚¤ãƒ†ãƒ åã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ */
.selected-item-text {
    font-size: 12px;  /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
    margin-right: 20px; /* å³å´ã«ä½™ç™½ã‚’è¿½åŠ  */
    white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²ã */
    overflow: hidden; /* ã¯ã¿å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º */
    text-overflow: ellipsis; /* ã¯ã¿å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œ...ã€ã«ã™ã‚‹ */
}

/* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’èª¿æ•´ */
.selected-item-delete {
    font-size: 14px;  /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
    position: absolute;
    right: 5px; /* å³ã«é…ç½® */
    top: 50%; /* ç¸¦æ–¹å‘ä¸­å¤® */
    transform: translateY(-50%); /* ç¸¦æ–¹å‘ä¸­å¤®æƒãˆ */
    cursor: pointer;
    background: none;
    border: none;
    color: red;
}


    </style>
    <div class="title-container">
        <h1>ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆæŠ•ç¨¿</h1>
    </div>

       
        {% if form.errors %}
        <div class="alert alert-danger">
            <ul>
                {% for field, errors in form.errors.items %}
                <li>{{ field }}: {{ errors|join:", " }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            
            <div class="mb-3">
                <label for="image" class="form-label">å†™çœŸã‚’é¸æŠ(â€»å¿…é ˆ):</label>
                <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
            </div>

            
            <div class="mb-3">
                <label for="title" class="form-label">ã‚¿ã‚¤ãƒˆãƒ«(â€»å¿…é ˆ):</label>
                <input type="text" class="form-control" id="title" name="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>

            
            <div class="mb-3">
                <label for="caption" class="form-label">ãƒ¡ãƒ¢:</label>
                <textarea class="form-control" id="caption" name="caption" rows="3" placeholder="ãƒ¡ãƒ¢ãƒ»ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>

            
            <div class="mb-3">
                <label>ä½¿ç”¨ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®æƒ…å ±:</label>
                <ul id="selected-items-list" class="list-unstyled">
                    
                </ul>
                <button type="button" class="btn btn-gray" data-bs-toggle="modal" data-bs-target="#itemModal">
                    ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
                </button>
            </div>

            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="is_public" name="is_public" value="1">
                <label class="form-check-label" for="is_public">
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã™ã‚‹
                </label>
            </div>

            
            <button type="submit" class="btn btn-gray">æŠ•ç¨¿</button>
        </form>
    </div>

    
    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æœã‚’é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button> 
                </div>
                <div class="modal-body">
                    
                        
                    
                    <div class="form-group">
                        <label for="genre-select">ã‚¸ãƒ£ãƒ³ãƒ«:</label>
                        <select id="genre-select" class="form-select">
                            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                            {% for genre in genres %}
                            <option value="{{ genre.0 }}">{{ genre.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label for="color-select">ã‚«ãƒ©ãƒ¼:</label>
                        <select id="color-select" class="form-select">
                            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                            {% for color in colors %}
                            <option value="{{ color.0 }}">{{ color.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label for="size-select">ã‚µã‚¤ã‚º:</label>
                        <select id="size-select" class="form-select">
                            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                            {% for size in sizes %}
                            <option value="{{ size.0 }}">{{ size.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="loadFilteredItems">æ¤œç´¢</button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="filteredItemModal" tabindex="-1" aria-labelledby="filteredItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ã‚¢ã‚¤ãƒ†ãƒ ã®é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
                </div>
                <div class="modal-body" id="filtered-items-container">
                    <
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="confirmSelection">é¸æŠã—ã¦åæ˜ </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchButton = document.getElementById('loadFilteredItems');
            if (!searchButton) return; // ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‡¦ç†ã—ãªã„
        
            searchButton.addEventListener('click', function () {
                const genre = document.getElementById('genre-select').value;
                const color = document.getElementById('color-select').value;
                const size = document.getElementById('size-select').value;
        
                const itemFilterUrl = "{% url 'item_filter' %}";
                const fullUrl = `${itemFilterUrl}?genre=${encodeURIComponent(genre)}&color=${encodeURIComponent(color)}&size=${encodeURIComponent(size)}`;
        
                console.log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${fullUrl}`);
        
                fetch(fullUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        const container = document.getElementById('filtered-items-container');
                        if (container) {
                            container.innerHTML = html;
                            new bootstrap.Modal(document.getElementById('filteredItemModal')).show();
                        } else {
                            console.error("filtered-items-container ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                        }
                    })
                    .catch(error => {
                        console.error('ã‚¢ã‚¤ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        alert('ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                    });
            });
        });
    
            // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨˜éŒ²ã™ã‚‹é…åˆ—
            let selectedItems = [];
    
            // ã€Œé¸æŠã—ã¦åæ˜ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
            document.addEventListener('click', function (event) {
                if (event.target && event.target.id === 'confirmSelection') {
                    console.log("âœ… 'é¸æŠã—ã¦åæ˜ ' ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
    
                    const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
                    const selectedItemsList = document.getElementById('selected-items-list');
                    
    
                    if (selectedCheckboxes.length === 0) {
                        alert('å°‘ãªãã¨ã‚‚1ã¤ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
    
                    // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ IDã‚’å–å¾—
                    let existingItemIds = selectedItems.map(item => item.id);
    
                    selectedCheckboxes.forEach((checkbox) => {
                        const itemName = checkbox.dataset.itemName;
                        const itemId = checkbox.dataset.itemId;
                        const itemImage = checkbox.dataset.itemImage;
    
                        if (!itemName || !itemImage) {
                            console.error('ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                            return;
                        }
    
                        // ä¸Šé™5ã¤ã¾ã§
                        if (selectedItems.length >= 5) {
                            alert('ã€Œä½¿ç”¨ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®æƒ…å ±ã€ã¯æœ€å¤§5ã¤ã¾ã§é¸æŠã§ãã¾ã™ã€‚');
                            return;
                        }
    
                        // ã™ã§ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        if (existingItemIds.includes(itemId)) {
                            return;
                        }
    
                        // ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        selectedItems.push({ id: itemId, name: itemName, image: itemImage });
    
                        // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤ºç”¨ã®è¦ç´ ä½œæˆ
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'border rounded p-2 d-flex align-items-center';
                        itemContainer.style.width = '150px';
                        itemContainer.style.padding = '10px';
                        itemContainer.style.display = 'flex';
                        itemContainer.style.alignItems = 'center';
                        itemContainer.style.position = 'relative';
                        itemContainer.style.border = '1px solid #ddd';
    
                        const imgTag = document.createElement('img');
                        imgTag.src = itemImage;
                        imgTag.alt = itemName;
                        imgTag.style.width = '50px';
                        imgTag.style.height = '50px';
                        imgTag.style.marginRight = '10px';
    
                        const textTag = document.createElement('span');
                        textTag.textContent = itemName;
                        textTag.className = 'selected-item-text'; // CSSã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
    
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                        deleteBtn.className = 'selected-item-delete'; // CSSã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
                        deleteBtn.addEventListener('click', function () {
                            // ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            selectedItems = selectedItems.filter(item => item.id !== itemId);
                            itemContainer.remove();
                        });
    
                        const inputTag = document.createElement('input');
                        inputTag.type = "hidden";
                        inputTag.name = "clothes";
                        inputTag.value = itemId;
    
                        itemContainer.appendChild(imgTag);
                        itemContainer.appendChild(textTag);
                        itemContainer.appendChild(deleteBtn);
                        itemContainer.appendChild(inputTag);
    
                        selectedItemsList.appendChild(itemContainer);
                    });
    
                    // ã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    const filteredItemModal = bootstrap.Modal.getInstance(document.getElementById('filteredItemModal'));
                    const itemModal = bootstrap.Modal.getInstance(document.getElementById('itemModal'));
    
                    if (filteredItemModal) filteredItemModal.hide();
                    if (itemModal) itemModal.hide();
                }
            });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    {% endblock %}