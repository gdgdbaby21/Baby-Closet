<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆæŠ•ç¨¿</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆæŠ•ç¨¿</h1>

        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º -->
        {% if form.errors %}
        <div class="alert alert-danger">
            <ul>
                {% for field, errors in form.errors.items %}
                <li>{{ field }}: {{ errors|join:", " }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- å†™çœŸã‚’é¸æŠ -->
            <div class="mb-3">
                <label for="image" class="form-label">å†™çœŸã‚’é¸æŠ:</label>
                <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
            </div>

            <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
            <div class="mb-3">
                <label for="title" class="form-label">ã‚¿ã‚¤ãƒˆãƒ«:</label>
                <input type="text" class="form-control" id="title" name="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>

            <!-- ãƒ¡ãƒ¢ -->
            <div class="mb-3">
                <label for="caption" class="form-label">ãƒ¡ãƒ¢:</label>
                <textarea class="form-control" id="caption" name="caption" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <!-- ä½¿ç”¨ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®æƒ…å ± -->
            <div class="mb-3">
                <label>ä½¿ç”¨ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®æƒ…å ±:</label>
                <ul id="selected-items-list" class="list-unstyled">
                    <!-- é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </ul>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal">
                    ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
                </button>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã™ã‚‹ -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="is_public" name="is_public" value="1">
                <label class="form-check-label" for="is_public">
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã™ã‚‹
                </label>
            </div>

            <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ -->
            <button type="submit" class="btn btn-success">æŠ•ç¨¿</button>
        </form>
    </div>

    <!-- ã‚¢ã‚¤ãƒ†ãƒ é¸æŠæ¡ä»¶ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
                </div>
                <div class="modal-body">
                    
                        
                    <!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                    <div class="form-group">
                        <label for="genre-select">ã‚¸ãƒ£ãƒ³ãƒ«:</label>
                        <select id="genre-select" class="form-select">
                            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                            {% for genre in genres %}
                            <option value="{{ genre.0 }}">{{ genre.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label for="color-select">ã‚«ãƒ©ãƒ¼:</label>
                        <select id="color-select" class="form-select">
                            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                            {% for color in colors %}
                            <option value="{{ color.0 }}">{{ color.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label for="size-select">ã‚µã‚¤ã‚º:</label>
                        <select id="size-select" class="form-select">
                            <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                            {% for size in sizes %}
                            <option value="{{ size.0 }}">{{ size.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-primary" id="loadFilteredItems">æ¤œç´¢</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="filteredItemModal" tabindex="-1" aria-labelledby="filteredItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ã‚¢ã‚¤ãƒ†ãƒ ã®é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
                </div>
                <div class="modal-body" id="filtered-items-container">
                    <!-- filtered_items.html ã®å†…å®¹ãŒã“ã“ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-primary" id="confirmSelection">é¸æŠã—ã¦åæ˜ </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // æ¤œç´¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ã
            document.getElementById('loadFilteredItems').addEventListener('click', function () {
                const genre = document.getElementById('genre-select').value;
                const color = document.getElementById('color-select').value;
                const size = document.getElementById('size-select').value;

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
                const itemFilterUrl = "{% url 'item_filter' %}";
                fetch(`${itemFilterUrl}?genre=${genre}&color=${color}&size=${size}`)
                    .then(response => response.text())
                    .then(html => {
                        const container = document.getElementById('filtered-items-container');
                        container.innerHTML = html;
                        const modal = new bootstrap.Modal(document.getElementById('filteredItemModal'));
                        modal.show();
                    })
                    .catch(error => {
                        console.error('ã‚¢ã‚¤ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        alert('ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    });
            });

            // ç¢ºå®šãƒœã‚¿ãƒ³ã§é¸æŠå†…å®¹ã‚’åæ˜ 
            document.getElementById('confirmSelection').addEventListener('click', function () {
                const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
                const selectedItemsList = document.getElementById('selected-items-list');
                


                if (selectedCheckboxes.length === 0) {
                    alert('å°‘ãªãã¨ã‚‚1ã¤ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                selectedCheckboxes.forEach((checkbox) => {
                    const itemName = checkbox.dataset.itemName;
                    const itemId = checkbox.dataset.itemId;
                    const itemImage = checkbox.dataset.itemImage;

                    if (!itemName || !itemImage) {
                        console.error('ã‚¢ã‚¤ãƒ†ãƒ åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                        return;
                    }

                    const liTag = document.createElement('li');
                    liTag.className = 'border rounded p-2 text-center position-relative d-flex flex-column align-items-center';
                    liTag.style.width = '120px';
                    liTag.style.padding = '10px';
                    liTag.style.margin = '5px';
                    liTag.style.display = 'inline-block';

                    const imgTag = document.createElement('img');
                    imgTag.src = itemImage;
                    imgTag.alt = itemName;
                    imgTag.style.width = '50px';
                    imgTag.style.height = '50px';
                    imgTag.style.marginRight = '10px';

                

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                    deleteBtn.className = 'border-0 bg-transparent text-danger';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.right = '5px';
                    deleteBtn.style.top = '5px';
                    deleteBtn.addEventListener('click', function () {
                    liTag.remove();
                });



                    liTag.textContent = itemName; 
                    liTag.className = 'd-flex align-items-center mb-2';

                    selectedItemsList.appendChild(liTag);


                    const inputTag = document.createElement('input');
                    inputTag.type="hidden";
                    inputTag.name="clothes";
                    inputTag.value=itemId;

                    liTag.appendChild(inputTag);
                    liTag.appendChild(imgTag);
                    liTag.appendChild(deleteBtn);
                    selectedItemsList.appendChild(liTag);
                });


                const modal = bootstrap.Modal.getInstance(document.getElementById('filteredItemModal'));
                modal.hide();
            });
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>